<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Theme Addition Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 20px;
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: 0 auto;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      button {
        padding: 10px 16px;
        font-size: 1rem;
        margin-top: 10px;
        cursor: pointer;
      }
      #status {
        margin-top: 20px;
        font-family: monospace;
        white-space: pre-wrap;
        background: #f1f1f1;
        padding: 10px;
        border-radius: 8px;
      }
      ul {
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Theme Addition App</h1>
      <p>
        This tool ingests new themes from <code>/input/theme.json</code> and
        creates folders under <code>/icons/</code> for each new theme (excluding
        ignored folders).
      </p>
      <button onclick="runThemeAddition()">Ingest New Themes</button>
      <div id="status">Status: Idle</div>

      <div
        style="
          display: flex;
          gap: 20px;
          flex-wrap: wrap;
          justify-content: space-between;
          margin-top: 20px;
        "
      >
        <div style="flex: 1 1 45%">
          <h2>Current Themes:</h2>
          <ul id="theme-list"></ul>
        </div>
      </div>

      <div style="flex: 1 1 45%">
        <h2>New Themes in theme.json:</h2>
        <ul id="input-theme-list"></ul>
      </div>
    </div>

    <div class="card">
      <h1>Icon Ingestion App</h1>
      <p>
        This tool ingests icons from <code>/input/icons.json</code> and saves
        each as a JSON file in its appropriate theme folder under
        <code>/icons/</code>.
      </p>
      <button onclick="runIconIngestion()">Ingest Icons</button>
      <div id="icon-status">Status: Idle</div>

      <div
        style="
          display: flex;
          gap: 20px;
          flex-wrap: wrap;
          justify-content: space-between;
          margin-top: 20px;
        "
      >
        <div style="flex: 1 1 45%">
          <h2>New Icon Ideas (icons.json):</h2>
          <ul id="input-icon-list"></ul>
        </div>
        <div style="flex: 1 1 45%">
          <h2>All Created Icons:</h2>
          <ul id="all-icon-list"></ul>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>Vectorization App</h1>
      <p>
        This tool finds all PNGs in <code>/input/</code>, vectorizes them, and
        moves each SVG to its correct folder using matching .json metadata.
      </p>
      <button onclick="startVectorization()">Vectorize Icons</button>
      <div id="vector-status">Status: Idle</div>

      <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px">
        <div style="flex: 1 1 45%">
          <h2>PNGs in Input:</h2>
          <div
            id="png-grid"
            style="
              max-height: 200px;
              overflow-y: scroll;
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
            "
          ></div>
        </div>
        <div style="flex: 1 1 45%">
          <h2>Vectorized SVGs:</h2>
          <div
            id="svg-grid"
            style="
              max-height: 200px;
              overflow-y: scroll;
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
            "
          ></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>App 5: SVG Match</h1>
      <button onclick="showSvgJsonMatches()">Check Matches</button>
      <div style="display: flex; gap: 20px; margin-top: 10px">
        <div style="flex: 1">
          <h2>JSON Files</h2>
          <ul id="json-match-list"></ul>
        </div>
        <div style="flex: 1">
          <h2>SVGs in /input/</h2>
          <ul id="svg-file-list"></ul>
        </div>
      </div>

      <div class="card">
        <h2>Finalize SVG Placement</h1>
        
        <button onclick="finalizeSvgPlacement()">Place SVGs</button>
        <div id="finalize-status">Status: Idle</div>
      </div>
    </div>

    <script>
      const IGNORED_FOLDERS = ["generated", "temp", "vectorized"];
      let matchedPairs = []; // Global array to store matching svg + json path pairs

      async function runThemeAddition() {
        document.getElementById("status").textContent =
          "Checking for new themes...";

        const response = await fetch("php/run_theme_addition.php");
        const result = await response.json();

        let statusText = "Added " + result.added.length + " new themes.";

        if (result.added.length > 0) {
          statusText +=
            result.added.length > 0
              ? "New Themes:" + result.added.map((t) => "- " + t).join("")
              : "No new themes found.";
        } else {
          statusText += "No new themes found.";
        }

        document.getElementById("status").textContent = statusText;
        renderThemeList(result.allThemes);
        reloadInputThemes();
      }

      async function renderThemeList(themes) {
        const list = document.getElementById("theme-list");
        list.innerHTML = "";
        themes
          .filter((theme) => !IGNORED_FOLDERS.includes(theme))
          .forEach((theme) => {
            const li = document.createElement("li");
            li.textContent = theme;
            list.appendChild(li);
          });
      }

      // Initial load
      window.onload = function () {
        fetch("php/list_themes.php")
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("status").textContent =
              "Loaded current themes.";
            renderThemeList(data);
          })
          .catch((err) => {
            document.getElementById("status").textContent =
              "Failed to load themes.";
            console.error(err);
          });

        reloadInputThemes();
        reloadInputIcons();
        loadAllIcons();
        loadPngGrid();
        loadSvgGrid();
      };

      function reloadInputThemes() {
        fetch("input/theme.json")
          .then((res) => res.json())
          .then((data) => {
            const inputList = document.getElementById("input-theme-list");
            inputList.innerHTML = "";
            (data.themes || []).forEach((theme) => {
              const li = document.createElement("li");
              li.textContent = theme;
              inputList.appendChild(li);
            });
          })
          .catch((err) => {
            const inputList = document.getElementById("input-theme-list");
            inputList.innerHTML = "<li>Failed to load theme.json</li>";
            console.error(err);
          });
      }

      function reloadInputIcons() {
        fetch("input/icons.json")
          .then((res) => res.json())
          .then((data) => {
            const inputList = document.getElementById("input-icon-list");
            inputList.innerHTML = "";
            (data || []).forEach((icon) => {
              const li = document.createElement("li");
              li.textContent = `${icon.name} (${icon.theme})`;
              inputList.appendChild(li);
            });
          })
          .catch((err) => {
            const inputList = document.getElementById("input-icon-list");
            inputList.innerHTML = "<li>Failed to load icons.json</li>";
            console.error(err);
          });
      }

      function loadAllIcons() {
        fetch("php/list_generated.php")
          .then((res) => res.json())
          .then((icons) => {
            const allList = document.getElementById("all-icon-list");
            allList.innerHTML = "";
            (icons || []).forEach((icon) => {
              if (icon.name && icon.theme) {
                const li = document.createElement("li");
                li.textContent = `${icon.name} (${icon.theme})`;
                allList.appendChild(li);
              }
            });
          })
          .catch((err) => {
            const allList = document.getElementById("all-icon-list");
            allList.innerHTML = "<li>Failed to load current icons</li>";
            console.error(err);
          });
      }

      function runIconIngestion() {
        document.getElementById("icon-status").textContent =
          "Processing icon ideas...";

        fetch("php/icon-idea-ingest.php")
          .then((res) => res.json())
          .then((data) => {
            document.getElementById(
              "icon-status"
            ).textContent = `Created ${data.created.length} icons.`;
            reloadInputIcons(); // ‚¨ÖÔ∏è Refresh the display after ingestion
            loadAllIcons(); // ‚¨ÖÔ∏è Optional: also refresh all created icons
          })
          .catch((err) => {
            document.getElementById("icon-status").textContent =
              "Failed to ingest icons.";
            console.error(err);
          });
      }

      async function loadPngGrid() {
        const res = await fetch("php/list_pngs.php");
        const files = await res.json();
        const grid = document.getElementById("png-grid");
        grid.innerHTML = "";
        files.forEach((f) => {
          const img = document.createElement("img");
          img.src = `input/${f}`;
          img.style.width = "64px";
          img.style.height = "64px";
          grid.appendChild(img);
        });
      }

      async function loadSvgGrid() {
        const res = await fetch("php/list_input_svg.php");
        const data = await res.json();

        console.log("SVG List Response:", data); // üîç Add this line

        const grid = document.getElementById("svg-grid");
        grid.innerHTML = "";

        if (!Array.isArray(data)) {
          grid.innerHTML = "<div style='color:red'>‚ùå Invalid SVG list</div>";
          return;
        }

        data.forEach((f) => {
          const img = document.createElement("img");
          img.src = f;
          img.style.width = "64px";
          img.style.height = "64px";
          grid.appendChild(img);
        });
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      async function startVectorization() {
        const statusBox = document.getElementById("vector-status");
        statusBox.textContent = "‚è≥ Starting vectorization...";

        const res = await fetch("php/list_pngs.php");
        const files = await res.json();

        for (const file of files) {
          const imagePath = "input/" + file;
          try {
            statusBox.innerHTML += `<div>üñºÔ∏è Processing ${imagePath}...</div>`;

            const bmpRes = await fetch("php/icon_to_bmp.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ image_path: imagePath }),
            });
            const bmpJson = await bmpRes.json();
            if (!bmpJson.success)
              throw new Error("BMP step failed: " + bmpJson.error);

            const svgRes = await fetch("php/bmp_to_svg.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ bmp_path: bmpJson.bmp_path }),
            });
            const svgJson = await svgRes.json();
            if (!svgJson.success)
              throw new Error("SVG step failed: " + svgJson.error);

            statusBox.innerHTML += `<div>‚úÖ Vectorized to ${svgJson.svg_path}</div>`;
          } catch (e) {
            statusBox.innerHTML += `<div style="color:red">‚ùå Error on ${file}: ${e.message}</div>`;
          }
        }

        loadPngGrid();
        loadSvgGrid();
        statusBox.innerHTML += "<hr>‚úÖ Done.";
      }

      async function finalizeSvgPlacement() {
        const statusBox = document.getElementById("finalize-status");
        statusBox.textContent = "üîÑ Placing matched SVGs...";

        if (!matchedPairs || matchedPairs.length === 0) {
          statusBox.innerHTML = "‚ùå Please click 'Check Matches' first.";
          return;
        }

        try {
          // Step 1: Move matched SVGs
          const res = await fetch("php/place_matched_svgs.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(matchedPairs),
          });

          const result = await res.json();

          statusBox.innerHTML =
            `‚úÖ Moved ${result.moved.length} SVGs.<br>` +
            `‚ö†Ô∏è Skipped ${result.failed.length} (missing or error).`;

          if (result.failed.length > 0) {
            result.failed.forEach((fail) => {
              statusBox.innerHTML += `‚ùå ${fail.svg}: ${fail.reason}<br>`;
            });
          }

          // Refresh SVG grid after move
          loadSvgGrid();

          // Step 2: Clean up PNGs
          console.log("üßπ Starting PNG cleanup...");
          const cleanupRes = await fetch("php/cleanup_pngs.php");
          const cleanup = await cleanupRes.json();
          console.log("üßπ Cleanup result:", cleanup);

          statusBox.innerHTML += `<br>üßπ Deleted ${cleanup.deleted.length} PNGs.`;
          if (cleanup.skipped.length > 0) {
            statusBox.innerHTML += `<br>‚ö†Ô∏è Skipped ${cleanup.skipped.length} PNGs.`;
          }

          // Refresh PNG grid after cleanup
          loadPngGrid();
        } catch (e) {
          statusBox.innerHTML = `‚ùå Error: ${e.message}`;
          console.error(e);
        }
      }

      async function showSvgJsonMatches() {
        const res = await fetch("php/list_json_and_svg_matches.php");
        const data = await res.json();

        const jsonList = document.getElementById("json-match-list");
        const svgList = document.getElementById("svg-file-list");

        jsonList.innerHTML = "";
        svgList.innerHTML = "";

        matchedPairs = []; // Reset global on each run

        const svgBaseNames = data.svg_files.map((f) =>
          f.toLowerCase().replace(/\.svg$/, "")
        );

        const matchSet = new Set(svgBaseNames);

        // Match tracking and display
        data.json_files.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item.name;

          if (matchSet.has(item.name.toLowerCase())) {
            li.style.color = "green";
            li.style.fontWeight = "bold";

            // Save matching pair info (full path to JSON assumed in item.path)
            matchedPairs.push({
              svg: `${item.name}.svg`,
              json: item.path, // this assumes item.path is present in your backend output
            });
          } else {
            li.style.color = "gray";
          }

          jsonList.appendChild(li);
        });

        data.svg_files.forEach((svg) => {
          const li = document.createElement("li");
          li.textContent = svg;
          svgList.appendChild(li);
        });
      }

    </script>
  </body>
</html>
