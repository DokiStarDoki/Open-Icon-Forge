<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Icon Forge Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      h2 {
        margin-top: 40px;
      }
      .section {
        background: #fff;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 0 5px #ccc;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
      }
      .output {
        margin-top: 10px;
        font-weight: bold;
      }
      .list {
        margin-top: 10px;
        font-family: monospace;
        background: #eee;
        padding: 10px;
        border-radius: 6px;
      }
      #generated-images img {
        max-height: 100px;
        margin-right: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
    </style>
    <script>
      let dashboard = {};

      window.onload = () => {
        loadDashboard();
      };

      async function loadDashboard() {
        const [dashRes, themeRes, iconRes] = await Promise.all([
          fetch("php/load_dashboard.php"),
          fetch("json/theme-backlog.json"),
          fetch("json/icon-backlog.json"),
        ]);

        const dashData = await dashRes.json();
        const themeData = await themeRes.json();
        const iconData = await iconRes.json();

        dashboard = {
          ...dashData,
          theme_backlog: themeData,
          icon_idea_backlog: iconData,
        };

        renderDashboard();
        loadGeneratedImages();
      }

      async function convertToSvgFromPngOrWebp(imagePath) {
        try {
          // STEP 1: Convert image (png/webp) to BMP
          const bmpResponse = await fetch("php/icon_to_bmp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image_path: imagePath }),
          });

          const bmpData = await bmpResponse.json();

          if (!bmpData.success) {
            console.error("BMP conversion failed:", bmpData.error);
            alert("Failed to create BMP.");
            return;
          }

          const bmpPath = bmpData.bmp_path;
          console.log("BMP created:", bmpPath);

          // STEP 2: Run Potrace to convert BMP to SVG
          const svgResponse = await fetch("php/bmp_to_svg.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bmp_path: bmpPath }),
          });

          const svgData = await svgResponse.json();

          if (!svgData.success) {
            console.error("Potrace failed:", svgData.error);
            alert("Failed to vectorize BMP.");
            return;
          }

          // Optional: update dashboard or preview
          console.log("SVG created:", svgData.svg_path);
          dashboard.vectorized_icon = {
            svg_path: svgData.svg_path,
            quality_check_passed: false,
          };
          renderDashboard();
          saveDashboard();
        } catch (err) {
          console.error("Error in vectorization pipeline:", err);
        }
      }

      function vectorizeIcon() {
        const path = dashboard.generated_icon?.png_path;
        if (!path) {
          alert("No icon selected for vectorization.");
          return;
        }
        convertToSvgFromPngOrWebp(path);
      }

      function renderDashboard() {
        document.getElementById("theme-output").innerText =
          dashboard.generated_theme?.name || "DISPLAY THEME GENERATED HERE";

        document.getElementById("theme-new-flag").innerText =
          "IS NEW: " + (dashboard.generated_theme?.is_new ?? "[TRUE/FALSE]");

        document.getElementById("theme-backlog").innerText =
          "Theme Backlog: " + dashboard.theme_backlog.join(", ");

        document.getElementById("selected-theme").innerText =
          dashboard.selected_theme || "DISPLAY SELECTED THEME HERE";

        document.getElementById("icon-idea").innerText =
          dashboard.generated_icon_idea?.idea ||
          "DISPLAY GENERATED ICON IDEA HERE";

        document.getElementById("icon-new-flag").innerText =
          "IS NEW: " +
          (dashboard.generated_icon_idea?.is_new ?? "[TRUE/FALSE]");

        document.getElementById("icon-backlog").innerText =
          "Icon Backlog: " +
          dashboard.icon_idea_backlog.map((i) => i.idea).join(", ");

        document.getElementById("grabbed-icon").innerText =
          "Selected Icon: " +
          (dashboard.generated_icon?.png_path || "None selected");

        document.getElementById("png-quality").innerText =
          "IS QUALITY (PNG): " +
          (dashboard.generated_icon?.quality_check_passed ?? "[TRUE/FALSE]");

        const svgPreview = document.getElementById("vector-preview");

        let previewHTML = "";

        // Show selected PNG/WebP preview
        if (dashboard.generated_icon?.png_path) {
          previewHTML += `
            <div>
              <strong>Original:</strong><br>
              <img src="${dashboard.generated_icon.png_path}" style="max-height:100px;">
            </div>`;
        }

        // Only show SVG if the path is in vectorized folder and PNG path matches
        if (
          dashboard.vectorized_icon?.svg_path &&
          dashboard.vectorized_icon.svg_path.startsWith("icons/vectorized/")
        ) {
          previewHTML += `
            <div style="margin-top:10px;">
              <strong>Vector:</strong><br>
              <img src="${dashboard.vectorized_icon.svg_path}" style="max-height:100px;">
            </div>`;
        }

        svgPreview.innerHTML = previewHTML || "DISPLAY VECTOR ICON HERE";

        document.getElementById("svg-quality").innerText =
          "IS QUALITY (SVG): " +
          (dashboard.vectorized_icon?.quality_check_passed ?? "[TRUE/FALSE]");

        const md = dashboard.metadata;
        document.getElementById("metadata-view").innerText = md
          ? `Name: ${md.name}\nDesc: ${
              md.short_description
            }\nTags: ${md.tags.join(", ")}`
          : "DISPLAY AND EDIT METADATA HERE";
      }

      async function loadGeneratedImages() {
        const response = await fetch("php/list_generated.php");
        const images = await response.json();
        const container = document.getElementById("generated-images");

        if (!Array.isArray(images)) {
          container.innerText = "Failed to load generated images.";
          return;
        }

        container.innerHTML = images
          .map(
            (path) =>
              `<img src="${path}" onclick="selectForVector('${path}')" alt="icon" title="${path
                .split("/")
                .pop()}">`
          )
          .join("");
      }

      function selectForVector(path) {
        dashboard.generated_icon = {
          png_path: path,
          quality_check_passed: false,
        };

        // Clear out old vector if switching to a new image
        dashboard.vectorized_icon = null;

        renderDashboard();
        saveDashboard();
      }

      async function saveDashboard() {
        await Promise.all([
          fetch("php/save_dashboard.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              selected_theme: dashboard.selected_theme,
              selected_icon: dashboard.selected_icon,
              generated_icon: dashboard.generated_icon,
              vectorized_icon: dashboard.vectorized_icon,
              metadata: dashboard.metadata,
              generated_theme: dashboard.generated_theme,
              generated_icon_idea: dashboard.generated_icon_idea,
            }),
          }),
          fetch("php/save_theme_backlog.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dashboard.theme_backlog),
          }),
          fetch("php/save_icon_backlog.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dashboard.icon_idea_backlog),
          }),
        ]);
      }

      async function generateTheme() {
        const response = await fetch("php/generate_theme.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            theme_backlog: dashboard.theme_backlog,
            themes_used: dashboard.completed_themes,
          }),
        });

        const data = await response.json();
        dashboard.generated_theme = {
          name: data.theme,
          is_new: data.is_new,
        };

        renderDashboard();
        saveDashboard();
      }

      function addThemeToBacklog() {
        if (
          dashboard.generated_theme?.name &&
          dashboard.generated_theme.is_new
        ) {
          dashboard.theme_backlog.push(dashboard.generated_theme.name);
          dashboard.generated_theme.is_new = false;
          renderDashboard();
          saveDashboard();
        }
      }

      function grabTopBacklogTheme() {
        if (dashboard.theme_backlog.length > 0) {
          dashboard.selected_theme = dashboard.theme_backlog.shift();
          renderDashboard();
          saveDashboard();
        }
      }

      async function generateIconIdea() {
        if (!dashboard.selected_theme) return;

        const existingIdeas = dashboard.icon_idea_backlog
          .filter((i) => i.theme === dashboard.selected_theme)
          .map((i) => i.idea);

        const response = await fetch("php/generate_icon_idea.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            selected_theme: dashboard.selected_theme,
            existing_ideas: existingIdeas,
          }),
        });

        const data = await response.json();
        dashboard.generated_icon_idea = {
          idea: data.idea,
          is_new: data.is_new,
        };

        renderDashboard();
        saveDashboard();
      }

      function addIconIdea() {
        if (
          dashboard.generated_icon_idea?.idea &&
          dashboard.generated_icon_idea.is_new
        ) {
          dashboard.icon_idea_backlog.push({
            theme: dashboard.selected_theme,
            idea: dashboard.generated_icon_idea.idea,
          });
          dashboard.generated_icon_idea.is_new = false;
          renderDashboard();
          saveDashboard();
        }
      }

      function grabTopIcon() {
        if (dashboard.icon_idea_backlog.length > 0) {
          dashboard.selected_icon = dashboard.icon_idea_backlog.shift();
          renderDashboard();
          saveDashboard();
        }
      }

      async function generateIcon() {
        const { theme, idea } = dashboard.selected_icon;
        const response = await fetch("php/generate_icon.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ theme, idea }),
        });

        const data = await response.json();
        dashboard.generated_icon = {
          png_path: data.png_path,
          quality_check_passed: false,
        };

        renderDashboard();
        saveDashboard();
        loadGeneratedImages(); // Refresh icon list
      }

      window.onload = loadDashboard;
    </script>
  </head>
  <body>
    <h1>Icon Forge Dashboard</h1>

    <div class="section">
      <h2>Action 1: Generate Theme</h2>
      <button onclick="generateTheme()">[GENERATE NEW THEME]</button>
      <button onclick="addThemeToBacklog()">[ADD THEME TO BACKLOG]</button>
      <div class="output" id="theme-output">DISPLAY THEME GENERATED HERE</div>
      <div class="output" id="theme-new-flag">IS NEW: [TRUE/FALSE]</div>
      <div class="list" id="theme-backlog">Theme Backlog: [List]</div>
    </div>

    <div class="section">
      <h2>Action 2: Generate Icon Idea</h2>
      <button onclick="grabTopBacklogTheme()">[GRAB TOP BACKLOG THEME]</button>
      <button onclick="generateIconIdea()">[GENERATE ICON IDEA]</button>
      <button onclick="addIconIdea()">[ADD ICON IDEA TO ICON BACKLOG]</button>
      <div class="output" id="selected-theme">DISPLAY SELECTED THEME HERE</div>
      <div class="output" id="icon-idea">DISPLAY GENERATED ICON IDEA HERE</div>
      <div class="output" id="icon-new-flag">IS NEW: [TRUE/FALSE]</div>
      <div class="list" id="icon-backlog">Icon Backlog: [List]</div>
    </div>

    <div class="section">
      <h2>Action 3: Generate Icon</h2>
      <button onclick="grabTopIcon()">[GRAB TOP BACKLOG ICON]</button>
      <button onclick="generateIcon()">[GENERATE ICON]</button>
      <div class="output" id="grabbed-icon">Selected Icon: [Grabbed icon]</div>
      <div class="output">Generated Icons:</div>
      <div
        id="generated-images"
        style="
          display: flex;
          overflow-x: auto;
          padding: 10px;
          background: #eee;
          border-radius: 6px;
        "
      >
        <!-- Auto-filled by loadGeneratedImages() -->
      </div>
      <div class="output" id="png-quality">IS QUALITY (PNG): [TRUE/FALSE]</div>
    </div>

    <div class="section">
      <h2>Action 4: Vectorize Icon</h2>
      <button onclick="vectorizeIcon()">[VECTORIZE ICON]</button>
      <div class="output" id="vector-preview">DISPLAY VECTOR ICON HERE</div>
      <div class="output" id="svg-quality">IS QUALITY (SVG): [TRUE/FALSE]</div>
    </div>

    <div class="section">
      <h2>Action 5: Finalize Metadata</h2>
      <button onclick="/* generateMetadata logic */">
        [GENERATE METADATA]
      </button>
      <button onclick="/* saveMetadata logic */">[SAVE METADATA]</button>
      <div class="output" id="metadata-view">
        DISPLAY AND EDIT METADATA HERE
      </div>
    </div>
  </body>
</html>
